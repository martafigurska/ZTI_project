<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Przepisy</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
        let currentUser = null;

        function updateUI() {
            document.getElementById('user-info').textContent = currentUser
                ? `Zalogowany jako: ${currentUser}`
                : 'Nie jeste≈õ zalogowany';
            document.getElementById('add-recipe-form').style.display = currentUser ? 'block' : 'none';
        }
        async function deleteRecipe(id) {
            if (!confirm("Czy na pewno chcesz usunƒÖƒá ten przepis?")) return;

            const response = await fetch(`/ZTI-1.0-SNAPSHOT/api/recipes/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert("Przepis usuniƒôty.");
                loadRecipes();
            } else {
                const text = await response.text();
                alert("B≈ÇƒÖd usuwania: " + text);
            }
        }

        async function loadRecipes() {
            const response = await fetch('/ZTI-1.0-SNAPSHOT/api/recipes');
            const recipes = await response.json();
            const list = document.getElementById('recipe-list');
            list.innerHTML = '';

            recipes.forEach(recipe => {
                const item = document.createElement('div');
                item.innerHTML = `
                    <h3>${recipe.title}</h3>
                    <p>${recipe.description}</p>
                    <p>Autor: ${recipe.author?.username || "nieznany"}</p>
                    <p>Lajk√≥w: ${recipe.likedByUsers?.length || 0}</p>
                    ${currentUser ? `<button onclick="likeRecipe(${recipe.id})">Lajkuj</button>` : ''}
                    ${currentUser === recipe.author?.username ? `<button onclick="deleteRecipe(${recipe.id})">Usu≈Ñ</button>` : ''}
                    <hr>
                `;
                list.appendChild(item);
            });

        }

        async function likeRecipe(id) {
            if (!currentUser) {
                alert("Zaloguj siƒô, aby lajkowaƒá.");
                return;
            }

            const response = await fetch(`/ZTI-1.0-SNAPSHOT/api/recipes/${id}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser })
            });

            if (response.ok) {
                loadRecipes();
            } else {
                const text = await response.text();
                alert("B≈ÇƒÖd: " + text);
            }
        }

        async function addRecipe(event) {
            event.preventDefault();
            if (!currentUser) {
                alert("Musisz byƒá zalogowany, aby dodaƒá przepis.");
                return;
            }

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();

            if (!title || !description) {
                alert("Uzupe≈Çnij pola!");
                return;
            }

            const response = await fetch('/ZTI-1.0-SNAPSHOT/api/recipes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title,
                    description,
                    author: { username: currentUser }
                })
            });

            if (response.ok) {
                document.getElementById('title').value = '';
                document.getElementById('description').value = '';
                await loadRecipes();
            } else {
                const text = await response.text();
                alert("B≈ÇƒÖd: " + text);
            }
        }

        async function register(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value.trim();

            const response = await fetch('/ZTI-1.0-SNAPSHOT/api/users/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, passwordHash: password })
            });

            if (response.ok) {
                alert("Zarejestrowano. Zaloguj siƒô.");
            } else {
                const text = await response.text();
                alert("B≈ÇƒÖd rejestracji: " + text);
            }
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            const response = await fetch('/ZTI-1.0-SNAPSHOT/api/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, passwordHash: password })
            });

            if (response.ok) {
                currentUser = username;
                localStorage.setItem('username', username);
                updateUI();
                loadRecipes();
                alert("Zalogowano.");
            } else {
                const text = await response.text();
                alert("B≈ÇƒÖd logowania: " + text);
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('username');
            updateUI();
            loadRecipes();
        }

        window.onload = function () {
            currentUser = localStorage.getItem('username');
            updateUI();
            loadRecipes();
        };
    </script>
</head>
<body>
<h1>üìí Przepisowo </h1>
<p id="user-info"></p>
<button onclick="logout()">Wyloguj</button>

<h2>üîê Rejestracja</h2>
<form onsubmit="register(event)">
    <input id="reg-username" type="text" placeholder="Login" required><br>
    <input id="reg-password" type="password" placeholder="Has≈Ço" required><br>
    <button type="submit">Zarejestruj</button>
</form>

<h2>üîë Logowanie</h2>
<form onsubmit="login(event)">
    <input id="login-username" type="text" placeholder="Login" required><br>
    <input id="login-password" type="password" placeholder="Has≈Ço" required><br>
    <button type="submit">Zaloguj</button>
</form>

<div id="add-recipe-form" style="display:none;">
    <h2>‚ûï Dodaj przepis</h2>
    <form onsubmit="addRecipe(event)">
        <input id="title" type="text" placeholder="Tytu≈Ç" required><br>
        <textarea id="description" placeholder="Opis" required></textarea><br>
        <button type="submit">Dodaj</button>
    </form>
</div>

<h2>üç≤ Przepisy</h2>
<div id="recipe-list">≈Åadowanie...</div>
</body>
</html>
