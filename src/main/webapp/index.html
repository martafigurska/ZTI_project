<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Logowanie / Rejestracja</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<nav>
    <button onclick="location.href='index.html'">Logowanie / Rejestracja</button>
    <button onclick="location.href='add-recipe.html'">Dodaj przepis</button>
    <button onclick="location.href='recipes.html'">Lista przepisów</button>
</nav>

<div id="reg">
    <p id="user-info" style="font-weight: bold; font-size: 1.2em; margin-bottom: 20px;"></p>
    <h1>Zaloguj się</h1>
    <form id="loginForm">
        <input name="username" placeholder="Login" required><br>
        <input name="password" type="password" placeholder="Hasło" required><br>
        <button type="submit">Zaloguj</button>
    </form>

    <h1>Zarejestruj się</h1>
    <form id="registerForm">
        <input name="username" placeholder="Login" required><br>
        <input name="password" type="password" placeholder="Hasło" required><br>
        <button type="submit">Zarejestruj</button>
    </form>
</div>
<a href="index.html" onclick="localStorage.clear()">Wyloguj</a>
<script>
    function updateUserInfo() {
        const userInfoElem = document.getElementById('user-info');
        const currentUser = localStorage.getItem('username');

        if (userInfoElem) {
            if (currentUser) {
                userInfoElem.textContent = `Zalogowany jako: ${currentUser}`;
            } else {
                userInfoElem.textContent = 'Nie jesteś zalogowany';
            }
        }
    }

    document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();

        const username = e.target.username.value;
        const password = e.target.password.value;

        if (!username || !password) {
            alert('Wprowadź login i hasło');
            return;
        }

        const body = {
            username: username,
            passwordHash: password
        };

        try {
            const res = await fetch('/ZTI-1.0-SNAPSHOT/api/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                localStorage.setItem('username', username);
                alert('Zalogowano pomyślnie!');
                window.location.href = 'recipes.html';
            } else {
                alert('Błąd logowania - sprawdź login i hasło');
            }
        } catch (error) {
            alert('Błąd połączenia z serwerem');
        }
    };

    document.getElementById('registerForm').onsubmit = async function(e) {
        e.preventDefault();

        const username = e.target.username.value;
        const password = e.target.password.value;

        if (!username || !password) {
            alert('Wprowadź login i hasło');
            return;
        }

        const body = {
            username: username,
            passwordHash: password
        };

        try {
            const res = await fetch('/ZTI-1.0-SNAPSHOT/api/users/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (res.ok) {
                alert('Rejestracja zakończona pomyślnie! Możesz się teraz zalogować.');
                e.target.reset();
            } else if (res.status === 409) {
                console.log(`BODY: ${JSON.stringify(body)}`);
                alert('Użytkownik o tym loginie już istnieje. Wybierz inny login.');
            } else {
                alert('Błąd rejestracji');
            }
        } catch (error) {
            alert('Błąd połączenia z serwerem');
        }
    };

    window.onload = function() {
        updateUserInfo();
    };
</script>
</body>
</html>
